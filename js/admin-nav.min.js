(()=>{const $=s=>document.querySelector(s),$$=s=>document.querySelectorAll(s);
function J(k){try{return JSON.parse(sessionStorage.getItem(k)||localStorage.getItem(k)||"null")}catch(e){return null}}
function L(r){return({member:0,moderator:1,admin:2,super_admin:3})[String(r||"member")]||0}
function now(){return Math.floor(Date.now()/1000)}
async function h(s){const b=new TextEncoder().encode(s),d=await crypto.subtle.digest("SHA-256",b);return Array.from(new Uint8Array(d)).map(x=>x.toString(16).padStart(2,"0")).join("")}
function cssOnce(){ if(document.getElementById("admLinkCSS"))return;
  const st=document.createElement("style"); st.id="admLinkCSS"; st.textContent=
  `.navbar .nav-link.admin-link{background:#dc3545;color:#fff!important;border-radius:10px;padding:.35rem .75rem;margin-left:.25rem}
   .navbar .nav-link.admin-link:hover,.navbar .nav-link.admin-link:focus{filter:brightness(.95)}
   #offcanvasMenu .nav-link.admin-link{background:#dc3545;color:#fff!important;border-radius:.5rem;margin:.25rem 0}`;
  document.head.appendChild(st);
}
function add(sel,href,text){
  $$(sel).forEach(ul=>{
    if(!ul) return; if(ul.querySelector(`a[href="${href}"]`)) return;
    const li=document.createElement("li"); li.className="nav-item";
    const a=document.createElement("a"); a.href=href; a.textContent=text;
    a.className=(ul.closest(".navbar-collapse")?"nav-link px-3 ":"nav-link ")+"admin-link";
    a.setAttribute("aria-label","Admin Board"); li.appendChild(a); ul.appendChild(li);
  });
}
async function okAdmin(){
  const u=J("userData")||{}; if(!u.ok) return !1;
  const role=String(u.rl||"member").toLowerCase(); if(L(role)<L("admin")) return !1; // hard block members
  if(!(window.sb&&window.sb.auth)) return null;
  const {data:sR}=await sb.auth.getSession(); const at=(sR&&sR.session&&sR.session.access_token)||"";
  const exp=+u.rlexp||0, sig=String(u.rlsig||""), expect=await h([String(u.row||""),role,String(exp),at].join("|"));
  return (exp>now()) && (sig===expect);
}
async function tryInject(){
  const navReady=!!($('.navbar .navbar-collapse .navbar-nav')||$('#navbarNav .navbar-nav')) && !!$('#offcanvasMenu .offcanvas-body .navbar-nav');
  if(!navReady) return null;
  const ok=await okAdmin(); if(ok===null) return null; if(!ok) return false;
  cssOnce();
  add('.navbar .navbar-collapse .navbar-nav','/admin-board/','Admin Board');       // desktop
  add('#navbarNav .navbar-nav','/admin-board/','Admin Board');                     // desktop (alt id)
  add('#offcanvasMenu .offcanvas-body .navbar-nav','/admin-board/','Admin Board'); // mobile
  return true;
}
document.addEventListener("DOMContentLoaded",()=>{let t0=Date.now(),id=setInterval(async()=>{const r=await tryInject(); if(r===true||Date.now()-t0>5000) clearInterval(id);},200);});
})();
